{
	# Configuración global
	admin off
	# Log en formato JSON para producción
	log {
		format json
	}
}

# Servidor principal
:8080 {
	# Directorio raíz
	root * /usr/share/caddy

	# Codificación
	encode gzip zstd

	# Headers de seguridad
	header {
		# Prevenir clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevenir MIME sniffing
		X-Content-Type-Options "nosniff"
		# XSS Protection
		X-XSS-Protection "1; mode=block"
		# Referrer Policy
		Referrer-Policy "strict-origin-when-cross-origin"
		# Content Security Policy (ajustar según necesidad)
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://aluna-api.deployhero.dev"
		# Permissions Policy
		Permissions-Policy "geolocation=(), microphone=(), camera=()"
	}

	# SPA routing - todas las rutas van a index.html
	try_files {path} /index.html

	# Servir archivos estáticos
	file_server

	# Health check endpoint
	handle /health {
		respond "OK" 200
	}

	# Cache para assets estáticos
	@static {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
	}
	header @static Cache-Control "public, max-age=31536000, immutable"

	# Cache para HTML (no cachear para permitir actualizaciones)
	@html {
		path *.html
	}
	header @html Cache-Control "no-cache, no-store, must-revalidate"

	# Log de accesos
	log {
		output file /var/log/caddy/access.log
		format json
	}
}
